---
layout: base
category: 03_Languages and Technologies
breadcrumb: Languages and Technologies
parent_url: ruby-overview.html
nav_title: Ruby
nav_priority: 50
meta_desc: Ruby Developers - OpenShift Resources to get your Ruby applications hosted in the cloud.
---
= Ruby Application Hosting

[float]
= Ruby Application Hosting
[.lead]
With OpenShift you can easily deploy and run Ruby applications using your favorite frameworks and databases. Want to run Ruby on Rails backed by MySQL? Or maybe you're looking for Sinatra and MongoDB? OpenShift Online currently supports `Ruby 1.8`, `1.9`, and `2.0`.

Ruby is a dynamic, reflective, general-purpose object-oriented programming language. Popular development frameworks include Ruby on Rails and Sinatra.

link:#create[Create a Ruby Application] +
link:#deploychanges[Make and Deploy Code Changes] +
link:#ruby[Ruby Project Structure]

image::ruby-logo.png[Ruby logo]

[[create]]
== Create a Ruby Application 


[[prerequisites]]
=== Prerequisites

This guide assumes that you have:

* Signed up for https://openshift.redhat.com/app/account/new[an OpenShift account] 
* Installed the RHC link:getting-started-client-tools.html[command line tools]

To create a new Ruby 2.0 application *myapp* using `rhc`, open a terminal window and enter the following command:

[source]
--
$ rhc app create myapp ruby-2.0 
--

OpenShift's default platform features include automatic DNS setup, SSH services, and a `git` server for publishing changes. The resulting output should contain a live URL where your application will be available:

[source]
--
http://MyApp-MyNamespace.rhcloud.com/
--

A Git repository created for your application and hosted on OpenShift will have been cloned to your local machine, into a directory with the same name as your app, *myapp*.

[[dbadd]]
=== Add a Database

To add a cartridge to your application, use `rhc cartridge add`. The following command adds a PostgreSQL database:

[source]
--
$ rhc cartridge add postgresql-9.2 -a myapp 
--

To view available cartridges, use the command `rhc cartridge list`. For community-supported cartridges, visit http://origin.ly[the OpenShift Origin Index].

To create an application with additional cartridges in one command, append them to `rhc app create`. For example:

[source]
--
$ rhc app create myapp ruby-2.0 postgresql-9.2 cron-1.4 
--

[[framework]]
=== Add a Framework

You can add a web framework or other template code to your OpenShift application using `git`. For example, the following command adds Rails 4 to the *myapp* Ruby application and deploys it to OpenShift. Note that this code requires a database cartridge, so you should add one now if you have not yet done so.

[source]
--
$ cd myapp
$ git pull -s recursive -X theirs https://github.com/openshift/rails4-example.git
$ git push
--

You could also add the template code at the same time as creating your application, using the `--from-code` option:

[source]
--
rhc app create myapp ruby-2.0 postgresql-9.2 --from-code=https://github.com/openshift/rails4-example.git -s
--

The `-s` option makes the application link:overview-platform-features.html#scaling[auto-scaling].

[[deploychanges]]
== Make and Deploy Code Changes

To make and deploy code changes to your application, use the `git` commands `add`, `commit`, and `push`. For example, the following commands add and deploy a *hot_deploy* marker file to the OpenShift application. If this marker file is present, OpenShift will not restart the server when deploying code changes.

[source]
--
$ touch .openshift/markers/hot_deploy
$ git add .
$ git commit -m "Adding hot deploy marker"
$ git push
--

Other code changes can be added and deployed in the same manner.

link:#top[Back to top]

[[ruby]]
== Ruby Project Structure 
The `ruby` cartridge provides a bare metal http://rack.github.io[Rack] application with http://www.ruby-lang.org[Ruby].

=== Template Repository Layout
[source]
--
tmp/               Temporary storage
public/            Content (images, CSS, etc. available to the public)
config.ru          This file is used by Rack-based servers to start the application.
.openshift/        Location for OpenShift specific files
    action_hooks/  See the Action Hooks documentation <1>
    markers/       See the Markers section below
--
<1> link:http://openshift.github.io/documentation/oo_user_guide.html#action-hooks[Action Hooks] documentation

=== Ruby Mirror
OpenShift is mirroring rubygems.org at http://mirror.ops.rhcloud.com/mirror/ruby/
This mirror is on the same network as your application, and your gem download should be faster.

To use the OpenShift mirror:

. Edit your Gemfile and replace
+
[source]
--
source 'https://rubygems.org'
--
+
with
+
[source]
--
source 'http://mirror.ops.rhcloud.com/mirror/ruby/'
--
. Edit your Gemfile.lock and replace
+
[source]
--
remote: https://rubygems.org/
--
+
with
+
[source]
--
remote: http://mirror.ops.rhcloud.com/mirror/ruby/
--

=== Deploying Rails

There are several approaches how to speed up deployment of your Rails application to OpenShift.

==== Gem installation

There are two options for deploying a Rails application to OpenShift.

*Method 1 (Recommended)* +
`git push` your application `Gemfile/Gemfile.lock`. This will cause the remote OpenShift node to run `bundle install --deployment` to download and install your dependencies.  Each subsequent git push will use the previously downloaded dependencies as a starting point, so additional downloads will be a delta.

*Method 2* +
`git add` your `.bundle` and `vendor/bundle` directories after running `bundle install --deployment` locally. Be sure to exclude any gems that have native code or ensure they can run on RHEL x86_64.

==== Asset pipeline

To prevent a long and unnecessary compilation of assets on application initial deployment and re-deployments, these two steps must be done.

Step 1* +
It's necessary to install `sprockets` gem by adding the line `gem 'turbo-sprockets-rails3'` into your Gemfile and run `bundle install`.

*Step 2* +
After `sprockets` gem is installed you need to precompile all your assets locally by `rake assets:precompile`, which compiles all the assets into `public/assets`. When compiling the assets the sprocket gem creates a file called `sources_manifest.yml`, located also in `public/assets`. This manifest contains names of all assets files together with their hash values. This file ensures that only changed assets will be recompiled on re-deployment.

==== Load database schema

If your Rails application contains a large amount of migrations it's good to use `db:schema:load` on initial deploy and `db:migrate` on re-deploymnets. You can do this by looking into the database and checking whether one of the DB tables exists.

This example checks, in the deploy hook, if the `spree_activators` table is present in the database.
[source, ruby]
--
if [ echo "use $OPENSHIFT_APP_NAME; show tables" | mysql | grep spree_activators ]
then
    bundle exec rake db:schema:load RAILS_ENV="production"
else
    bundle exec rake db:migrate RAILS_ENV="production"
fi
--

=== Environment Variables
The `ruby` cartridge provides several environment variables to reference for ease of use:

OPENSHIFT_RUBY_LOGDIR:: Log files go here.
OPENSHIFT_RUBY_VERSION:: The Ruby language version. The valid values are `1.8` and `1.9`.
BUNDLE_WITHOUT: Prevents Bundler from installing certain groups specified in the Gemfile.

=== Using RAILS_ENV=development

In OpenShift you can use the Rails development environment as you do when you
are developing the Rails application locally. To instruct OpenShift to deploy
your application in development mode, you need to set this user-environment
variable:

* `RAILS_ENV` (eg. `rhc env set RAILS_ENV=development`)

When the Rails application run under development environment OpenShift will:

* Skip the automatic static asset (re)compilation
* Disable `bundle` command unless you do modification to the application Gemfile
* Set web server to run your application in 'development' mode
* Skip full restart of the Apache as the code is reloaded automatically

The development mode can speed up the development phase of you application in
OpenShift, but it is not recommended to use this mode for production.

=== `threaddump` command
OpenShift's CLI tool, https://rubygems.org/gems/rhc[`rhc`], has a subcommand `threaddump`. Applications created by this cartridge respond to this command by looking
for the appropriate `Rack` process, and sending `ABRT` signal to it. As explained in the http://www.modrails.com/documentation/Users%20guide%20Apache.html#debugging_frozen[Passenger User Guide], this signal will dump the current thread backtraces but also terminates the processes.

NOTE: The `Rack` process may not exist if the application has just started and has not been accessed.

=== Markers
Adding marker files to `.openshift/markers` will have the following effects:

[cols="1,3",options="header"]
|===
|Marker |Effect

|force_clean_build
|Will trigger a clean re-bundle during the build cycle.

|hot_deploy
|Will prevent shutdown and startup of the application during builds. The Passenger `restart.txt` file will be used to reload the application.

|disable_asset_compilation
|Will prevent assets to be compiled upon application deployment. This marker should be used when deploying application with assets which are already compiled.
|===

link:#top[Back to top]
